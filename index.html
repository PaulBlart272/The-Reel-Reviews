<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Reel Reviews (TMDB)</title>

  <style>
    :root{
      --bg:#0b1020;
      --panel: rgba(255,255,255,0.08);
      --panel2: rgba(255,255,255,0.12);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.72);
      --line: rgba(255,255,255,0.14);
      --radius: 18px;
      --shadow: 0 18px 50px rgba(0,0,0,0.55);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% 10%, rgba(99,102,241,0.22), transparent 60%),
                  radial-gradient(1000px 700px at 80% 30%, rgba(16,185,129,0.16), transparent 55%),
                  var(--bg);
      color: var(--text);
    }

    .wrap{ width:min(1100px, 92vw); margin: 28px auto; }
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap: 16px; padding: 18px 18px; border-radius: var(--radius);
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      box-shadow: var(--shadow);
      border: 1px solid var(--line);
    }
    h1{ margin:0; font-size: 1.1rem; letter-spacing: 0.4px; }
    .muted{ color: var(--muted); font-size: .92rem; }

    .controls{
      display:flex; gap:10px; align-items:center; flex-wrap: wrap;
      justify-content:flex-end;
    }
    input, button, select{
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 10px 12px;
      outline: none;
    }
    input{ width: 260px; }
    button{ cursor:pointer; }
    button:hover{ background: rgba(255,255,255,0.10); }
    .pill{
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.06);
      font-size: .9rem;
      cursor:pointer;
    }
    .pill[aria-pressed="true"]{
      background: rgba(99,102,241,0.22);
      border-color: rgba(99,102,241,0.45);
    }

    main{
      margin-top: 18px;
      padding: 18px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
    }

    .status{ display:flex; justify-content:space-between; align-items:center; gap: 14px; }
    .status strong{ font-weight: 650; }
    .grid{
      margin-top: 16px;
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 14px;
    }

    .card{
      border: 1px solid var(--line);
      background: rgba(0,0,0,0.18);
      border-radius: 16px;
      overflow:hidden;
      display:flex;
      flex-direction: column;
      min-height: 320px;
      transition: transform .12s ease, background .12s ease;
      cursor: pointer;
    }
    .card:hover{ transform: translateY(-2px); background: rgba(0,0,0,0.26); }
    .poster{
      width: 100%;
      aspect-ratio: 2/3;
      background: rgba(255,255,255,0.05);
      display:block;
      object-fit: cover;
    }
    .card-body{ padding: 10px 10px 12px; display:flex; flex-direction:column; gap: 6px; }
    .title{ font-size: .96rem; font-weight: 650; line-height: 1.2; }
    .meta{ display:flex; justify-content:space-between; gap: 10px; color: var(--muted); font-size: .85rem; }
    .tag{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      font-size: .86rem;
      white-space: nowrap;
    }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .right{ margin-left:auto; }

    footer{
      margin-top: 14px;
      color: var(--muted);
      font-size: .85rem;
      text-align:center;
    }
    a{ color: inherit; }

    /* Review modal */
    .modal{
      position:fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center;
      z-index: 1000;
    }
    .modal-content{
      background: var(--bg); padding: 20px; border-radius: var(--radius);
      border: 1px solid var(--line); max-width: 400px; width: 90%;
    }
    .modal h3{ margin-top:0; }
    .modal textarea{ width:100%; height: 80px; resize: vertical; }
    .modal .buttons{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>The Reel Reviews</h1>
        <div class="muted">Powered by TMDB (Top Rated + Search)</div>
      </div>

      <div class="controls">
        <div class="row">
          <button class="pill" id="btnTopRated" aria-pressed="true" title="Show Top Rated">Top Rated</button>
          <button class="pill" id="btnTrending" aria-pressed="false" title="Show Trending This Week">Trending</button>
        </div>

        <input id="q" type="search" placeholder="Search movies (e.g., Interstellar)" />
        <button id="btnSearch">Search</button>
        <button id="btnClear" title="Clear search / reload list">Reset</button>
      </div>
    </header>

    <main>
      <div class="status">
        <div>
          <strong id="heading">Top Rated</strong>
          <span class="muted" id="subheading">Loading…</span>
        </div>
        <div class="row right">
          <span class="tag" id="countTag">0 results</span>
          <span class="tag" id="pageTag">page 1</span>
        </div>
      </div>

      <div class="grid" id="grid"></div>
    </main>

    <footer>
      This product uses the TMDB API but is not endorsed or certified by TMDB.
    </footer>
  </div>

  <!-- Review Modal -->
  <div id="reviewModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3 id="reviewTitle">Review Movie</h3>
      <label>Rating: <input type="number" id="reviewRating" min="1" max="10" value="5"></label>
      <textarea id="reviewText" placeholder="Write your review..."></textarea>
      <div class="buttons">
        <button id="btnSaveReview">Save</button>
        <button id="btnCancelReview">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // 1) TMDB KEY (HARD CODED)
    // ==========================
    const TMDB_KEY = "f3d5a69de29b2aca7f4604239c3bb8f4";

    // ==========================
    // 2) BASIC TMDB CONSTANTS
    // ==========================
    const TMDB_API = "https://api.themoviedb.org/3";
    const IMG_BASE = "https://image.tmdb.org/t/p/w500"; // posters
    const FALLBACK_POSTER = ""; // you can add your own fallback image url

    // App state
    let mode = "top_rated"; // "top_rated" | "trending" | "search"
    let currentPage = 1;
    let lastQuery = "";
    let currentMovieForReview = null;

    // Elements
    const grid = document.getElementById("grid");
    const heading = document.getElementById("heading");
    const subheading = document.getElementById("subheading");
    const countTag = document.getElementById("countTag");
    const pageTag = document.getElementById("pageTag");

    const q = document.getElementById("q");
    const btnSearch = document.getElementById("btnSearch");
    const btnClear = document.getElementById("btnClear");
    const btnTopRated = document.getElementById("btnTopRated");
    const btnTrending = document.getElementById("btnTrending");

    const reviewModal = document.getElementById("reviewModal");
    const reviewTitle = document.getElementById("reviewTitle");
    const reviewRating = document.getElementById("reviewRating");
    const reviewText = document.getElementById("reviewText");
    const btnSaveReview = document.getElementById("btnSaveReview");
    const btnCancelReview = document.getElementById("btnCancelReview");

    function setPillStates() {
      btnTopRated.setAttribute("aria-pressed", mode === "top_rated" ? "true" : "false");
      btnTrending.setAttribute("aria-pressed", mode === "trending" ? "true" : "false");
    }

    function requireKeyOrDie() {
      if (!TMDB_KEY || TMDB_KEY.includes("PASTE_YOUR_TMDB_API_KEY_HERE")) {
        grid.innerHTML = `
          <div class="muted" style="grid-column: 1 / -1; padding: 10px;">
            <strong>Missing TMDB API key.</strong><br>
            Open this file, find <code>TMDB_KEY</code>, and paste your TMDB v3 API key.
          </div>
        `;
        subheading.textContent = "Add your TMDB key to load movies.";
        return false;
      }
      return true;
    }

    async function tmdb(path, params = {}) {
      const url = new URL(TMDB_API + path);
      url.searchParams.set("api_key", TMDB_KEY);
      url.searchParams.set("language", "en-US");
      for (const [k, v] of Object.entries(params)) url.searchParams.set(k, v);

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout

      const res = await fetch(url.toString(), { signal: controller.signal });
      clearTimeout(timeoutId);
      if (!res.ok) {
        const text = await res.text().catch(() => "");
        if (res.status === 429) throw new Error("Rate limit exceeded. Please wait and try again.");
        throw new Error(`TMDB error ${res.status}: ${text || res.statusText}`);
      }
      return res.json();
    }

    function posterUrl(movie) {
      if (movie.poster_path) return IMG_BASE + movie.poster_path;
      return FALLBACK_POSTER || "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="400" height="600">
          <rect width="100%" height="100%" fill="rgba(255,255,255,0.06)"/>
          <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
            fill="rgba(255,255,255,0.65)" font-family="system-ui, sans-serif" font-size="18">
            No Poster
          </text>
        </svg>
      `);
    }

    function movieYear(movie) {
      const d = movie.release_date || "";
      return d ? d.slice(0, 4) : "—";
    }

    function rating(movie) {
      if (typeof movie.vote_average !== "number") return "—";
      return movie.vote_average.toFixed(1);
    }

    function openTMDB(movieId) {
      // TMDB movie page (public)
      window.open(`https://www.themoviedb.org/movie/${movieId}`, "_blank", "noopener,noreferrer");
    }

    function getUserReviews() {
      return JSON.parse(localStorage.getItem("user_reviews") || "{}");
    }

    function saveUserReviews(reviews) {
      localStorage.setItem("user_reviews", JSON.stringify(reviews));
    }

    function getUserReview(movieId) {
      const reviews = getUserReviews();
      return reviews[movieId] || null;
    }

    function setUserReview(movieId, rating, text) {
      const reviews = getUserReviews();
      reviews[movieId] = { rating: parseInt(rating), text: text.trim(), date: Date.now() };
      saveUserReviews(reviews);
    }

    function showReviewModal(movie) {
      currentMovieForReview = movie;
      reviewTitle.textContent = `Review: ${movie.title}`;
      const existing = getUserReview(movie.id);
      reviewRating.value = existing ? existing.rating : 5;
      reviewText.value = existing ? existing.text : "";
      reviewModal.style.display = "flex";
    }

    function hideReviewModal() {
      reviewModal.style.display = "none";
      currentMovieForReview = null;
    }

    function renderMovies(list = []) {
      grid.innerHTML = "";

      if (!list.length) {
        grid.innerHTML = `
          <div class="muted" style="grid-column: 1 / -1; padding: 10px;">
            No results found.
          </div>
        `;
        return;
      }

      const frag = document.createDocumentFragment();

      for (const m of list) {
        const card = document.createElement("div");
        card.className = "card";

        const img = document.createElement("img");
        img.className = "poster";
        img.alt = m.title || "Movie poster";
        img.loading = "lazy";
        img.src = posterUrl(m);
        img.addEventListener("click", () => openTMDB(m.id));

        const body = document.createElement("div");
        body.className = "card-body";

        const t = document.createElement("div");
        t.className = "title";
        t.textContent = m.title || m.name || "Untitled";

        const meta = document.createElement("div");
        meta.className = "meta";
        const userReview = getUserReview(m.id);
        const userRating = userReview ? ` (You: ${userReview.rating}/10)` : "";
        meta.innerHTML = `<span>${movieYear(m)}</span><span>⭐ ${rating(m)}${userRating}</span>`;

        const reviewBtn = document.createElement("button");
        reviewBtn.className = "tag";
        reviewBtn.textContent = userReview ? "Edit Review" : "Add Review";
        reviewBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          showReviewModal(m);
        });

        body.appendChild(t);
        body.appendChild(meta);
        body.appendChild(reviewBtn);

        card.appendChild(img);
        card.appendChild(body);
        frag.appendChild(card);
      }

      grid.appendChild(frag);
    }

    function setStatus({ title, subtitle, count, page }) {
      heading.textContent = title;
      subheading.textContent = subtitle;
      countTag.textContent = `${count} result${count === 1 ? "" : "s"}`;
      pageTag.textContent = `page ${page}`;
    }

    async function loadTopRated(page = 1) {
      mode = "top_rated";
      setPillStates();
      currentPage = page;

      setStatus({ title: "Top Rated", subtitle: "Loading…", count: 0, page });
      try {
        const data = await tmdb("/movie/top_rated", { page });
        renderMovies(data.results || []);
        setStatus({
          title: "Top Rated",
          subtitle: "Movies with the highest TMDB ratings.",
          count: (data.results || []).length,
          page: data.page || page
        });
      } catch (err) {
        setStatus({ title: "Top Rated", subtitle: `Error: ${err.message}`, count: 0, page });
        renderMovies([]);
      }
    }

    async function loadTrending(page = 1) {
      mode = "trending";
      setPillStates();
      currentPage = page;

      setStatus({ title: "Trending", subtitle: "Loading…", count: 0, page });
      try {
        const data = await tmdb("/trending/movie/week", { page });
        renderMovies(data.results || []);
        setStatus({
          title: "Trending (This Week)",
          subtitle: "What people are watching right now.",
          count: (data.results || []).length,
          page: data.page || page
        });
      } catch (err) {
        setStatus({ title: "Trending", subtitle: `Error: ${err.message}`, count: 0, page });
        renderMovies([]);
      }
    }

    async function searchMovies(query, page = 1) {
      mode = "search";
      setPillStates(); // pills off
      currentPage = page;
      lastQuery = query;

      setStatus({ title: "Search", subtitle: "Loading…", count: 0, page });
      try {
        const data = await tmdb("/search/movie", {
          query,
          page,
          include_adult: "false"
        });

        renderMovies(data.results || []);
        setStatus({
          title: `Search: "${query}"`,
          subtitle: "Results from TMDB search.",
          count: (data.results || []).length,
          page: data.page || page
        });
      } catch (err) {
        setStatus({ title: "Search", subtitle: `Error: ${err.message}`, count: 0, page });
        renderMovies([]);
      }
    }

    // ==========================
    // UI WIRING
    // ==========================
    btnTopRated.addEventListener("click", () => loadTopRated(1));
    btnTrending.addEventListener("click", () => loadTrending(1));

    btnSearch.addEventListener("click", () => {
      const query = q.value.trim();
      if (!query) return;
      searchMovies(query, 1);
    });

    q.addEventListener("keydown", (e) => {
      if (e.key === "Enter") btnSearch.click();
    });

    btnClear.addEventListener("click", () => {
      q.value = "";
      loadTopRated(1);
    });

    // Review modal
    btnSaveReview.addEventListener("click", () => {
      if (!currentMovieForReview) return;
      const rating = reviewRating.value;
      const text = reviewText.value;
      setUserReview(currentMovieForReview.id, rating, text);
      hideReviewModal();
      // Re-render current view
      if (mode === "top_rated") loadTopRated(currentPage);
      else if (mode === "trending") loadTrending(currentPage);
      else if (mode === "search") searchMovies(lastQuery, currentPage);
    });

    btnCancelReview.addEventListener("click", hideReviewModal);

    // Optional: simple next/prev using keyboard arrows
    window.addEventListener("keydown", async (e) => {
      if (e.target && (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA")) return;

      const maxPage = 500; // TMDB limit

      if (e.key === "ArrowRight") {
        const next = currentPage + 1;
        if (next <= maxPage) {
          if (mode === "top_rated") await loadTopRated(next);
          else if (mode === "trending") await loadTrending(next);
          else if (mode === "search" && lastQuery) await searchMovies(lastQuery, next);
        }
      }

      if (e.key === "ArrowLeft" && currentPage > 1) {
        const prev = currentPage - 1;
        if (mode === "top_rated") await loadTopRated(prev);
        else if (mode === "trending") await loadTrending(prev);
        else if (mode === "search" && lastQuery) await searchMovies(lastQuery, prev);
      }
    });

    // ==========================
    // START
    // ==========================
    (async function init(){
      if (!requireKeyOrDie()) return;
      try {
        await loadTopRated(1);
      } catch (err) {
        grid.innerHTML = `
          <div class="muted" style="grid-column: 1 / -1; padding: 10px;">
            <strong>Couldn’t load TMDB.</strong><br>
            ${String(err.message || err)}
          </div>
        `;
        subheading.textContent = "Check your API key and internet connection.";
      }
    })();
  </script>
</body>
</html>
